<!DOCTYPE html>

<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>ç”Ÿæ—¥å¿«ä¹ æ²ˆé›¨åª Â· è¿›é˜¶ç‰ˆ</title>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<style>
    :root{
      --pink:#e91e63; --pink2:#ff80ab; --mask:rgba(0,0,0,.55);
      --gold:#ffd54f; --green:#4caf50; --deep:#111; --light:#eee;
    }
    html,body{height:100%}
    body{margin:0;padding:0;overflow:hidden;text-align:center;background:#000;
      font-family:"å¾®è½¯é›…é»‘",system-ui,-apple-system,Segoe UI,Roboto,PingFang SC;}

    .stage{position:absolute;inset:0;display:flex;flex-direction:column;
      justify-content:center;align-items:center;background:var(--mask);
      color:#fff;transition:opacity .6s ease;}
    .hidden{opacity:0;pointer-events:none}
    h1,h2{color:var(--pink2);text-shadow:0 0 10px rgba(255,128,171,.6);margin:.2rem 0}
    button{margin:10px;padding:12px 22px;border:none;border-radius:24px;
      background:linear-gradient(45deg,var(--pink),var(--pink2));color:#fff;font-size:1.05em;
      cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.35);transition:transform .18s;}
    button:hover{transform:scale(1.05)}
    canvas#bg{position:absolute;inset:0;z-index:-1}

    /* Stage1 hearts */
    #hearts{position:relative;width:100%;height:60%}
    .heart{position:absolute;font-size:3.2em;cursor:pointer;user-select:none;
      animation:float 6s infinite ease-in-out;text-shadow:0 2px 6px rgba(0,0,0,.6)}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-18px)}100%{transform:translateY(0)}}

    /* Stage2 catch */
    #basket{position:absolute;bottom:18px;width:120px;height:56px;background:#d81b60;border-radius:16px;
      text-align:center;line-height:56px;color:#fff;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,.4)}
    .gift{position:absolute;font-size:2em;user-select:none}
    .timer-wrap{width:70vw;max-width:520px;height:10px;background:rgba(255,255,255,.18);
      border-radius:999px;overflow:hidden;box-shadow:inset 0 0 8px rgba(0,0,0,.35)}
    .timer-bar{height:100%;background:linear-gradient(90deg,#ffd54f,#ff7043);width:100%;transition:width .2s linear}
    .mobile-hint{position:absolute;bottom:76px;left:50%;transform:translateX(-50%);font-size:.95em;opacity:.85}
    .retry{display:none}

    /* Stage3 puzzle */
    #puzzle{width:306px;height:306px;display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);
      gap:2px;padding:4px;border-radius:10px;background:rgba(255,255,255,.06);box-shadow:0 6px 18px rgba(0,0,0,.4)}
    .p-piece{width:100px;height:100px;background-size:300px 300px;background-repeat:no-repeat;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.45)}
    .success-text{margin-top:14px;color:var(--gold);font-weight:700;opacity:0;transform:translateY(8px);transition:all .5s ease}
    .success-text.show{opacity:1;transform:translateY(0)}

    /* Stage4 asteroid */
    #asteroid-area{position:relative;width:90%;max-width:520px;height:520px;background:rgba(255,255,255,.06);
      border:2px solid var(--pink2);border-radius:12px;overflow:hidden;touch-action:none}
    #ship{position:absolute;font-size:2em;user-select:none}
    .asteroid{position:absolute;font-size:1.6em;user-select:none}

    /* Stage5 breakout */
    #breakout-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    #breakout{background:rgba(255,255,255,.06);border:2px solid var(--pink2);border-radius:12px;touch-action:none}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);margin-left:6px;font-size:.9em}

    /* Stage6 maze */
    #maze-wrap{display:flex;flex-direction:column;align-items:center;gap:10px}
    #maze-grid{display:grid;gap:2px;background:rgba(255,255,255,.06);padding:6px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.4)}
    .cell{width:26px;height:26px;background:#333}
    .wall{background:#111}
    .player{background:#ff4081}
    .exit{background:var(--green)}
    .dirpad{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .dirpad button{padding:10px 14px;border-radius:10px}

    /* Stage7 toast */
    .toast{position:absolute;top:12%;left:50%;transform:translateX(-50%);
      padding:8px 16px;border-radius:999px;background:rgba(0,0,0,.45);color:#fff;font-weight:600;backdrop-filter:blur(4px);
      opacity:0;transition:opacity .35s, transform .35s}
    .toast.show{opacity:1;transform:translate(-50%,0)}

    /* Finale */
    #final-msg{font-size:2.4em;color:var(--pink2);font-weight:800;animation:glow 2s infinite alternate}
    @keyframes glow{from{text-shadow:0 0 8px #ff80ab}to{text-shadow:0 0 26px #c2185b}}
    #final-photo{width:260px;border-radius:14px;margin-top:18px;box-shadow:0 8px 24px rgba(0,0,0,.6)}
  </style>
</head>
<body>
<!-- éŸ³ä¹ -->
<audio autoplay="autoplay" id="bg-music" loop="loop" muted="muted" style="display:none;">
<source src="music.mp3" type="audio/mpeg"/>
</audio>
<audio id="s-catch" preload="auto" src="catch.mp3"></audio>
<audio id="s-bomb" preload="auto" src="bomb.mp3"></audio>
<!-- æ˜Ÿç©ºèƒŒæ™¯ -->
<canvas id="bg"></canvas>
<!-- Stage1 æ‰¾çœŸå¿ƒ -->
<div class="stage" id="stage1">
<h1>ğŸ‚ æ²ˆé›¨åªï¼Œä»Šå¤©æ˜¯ä½ çš„å†’é™©ç”Ÿæ—¥ä¹‹æ—…ï¼</h1>
<p>ç‚¹ä¸­çœŸæ­£é‚£é¢—ã€ŒçœŸå¿ƒã€æ‰èƒ½ç»§ç»­ ğŸ’–ï¼ˆåˆ«ç‚¹å‡å¿ƒå¿ƒå“¦ï¼‰</p>
<div id="hearts"></div>
</div>
<!-- Stage2 æ¥ç¤¼ç‰© -->
<div class="stage hidden" id="stage2">
<h2>ç¬¬äºŒå…³ï¼šæ¥ä½ 10 ä¸ªç¤¼ç‰©ï¼ ğŸï¼ˆå°å¿ƒ ğŸ’£ï¼‰</h2>
<div class="timer-wrap" style="margin:6px 0 8px;"><div class="timer-bar" id="timerBar"></div></div>
<div>å¾—åˆ†ï¼š<b id="score">0</b> / 10</div>
<div id="basket">ç¯®å­</div>
<div class="mobile-hint">ğŸ“± æç¤ºï¼šå·¦å³æ»‘åŠ¨/æ‹–åŠ¨å±å¹•ç§»åŠ¨ç¯®å­</div>
<button class="retry" id="retryCatch">é‡è¯•æœ¬å…³</button>
</div>
<!-- Stage3 æ‹¼å›¾ -->
<div class="stage hidden" id="stage3">
<h2>ç¬¬ä¸‰å…³ï¼šæ‹¼å‡ºæˆ‘ä»¬çš„åˆç…§ ğŸ§©</h2>
<div id="puzzle"></div>
<div class="success-text" id="puzzleOk">å®Œæˆå•¦ï¼å¥½æ£’ ğŸ‘</div>
</div>
<!-- Stage4 èº²é¿é™¨çŸ³ -->
<div class="stage hidden" id="stage4">
<h2>ç¬¬å››å…³ï¼šèº²é¿é™¨çŸ³ ğŸš€</h2>
<p>æ–¹å‘é”®/WASDï¼›æ‰‹æœºç‚¹å‡»å·¦/å³åŠåŒºç§»åŠ¨ï¼›åšæŒ <b>20</b> ç§’è¿‡å…³</p>
<div id="asteroid-area"><div id="ship">ğŸš€</div></div>
<div id="asteroid-hud">å‰©ä½™æ—¶é—´ï¼š<b id="ast-sec">20</b> ç§’ <span class="badge">æ’åˆ°å¤±è´¥</span></div>
<button class="retry" id="retryAst">é‡è¯•æœ¬å…³</button>
</div>
<!-- Stage5 æ‰“ç –å—ï¼ˆå¸¦é“å…·ï¼‰ -->
<div class="stage hidden" id="stage5">
<h2>ç¬¬äº”å…³ï¼šæ‰“ç –å— ğŸ§± <span class="badge">é“å…·ï¼šæ‰©æ¿ / ç¼©æ¿ / å¤šçƒ / æ…¢é€Ÿ / åŠ é€Ÿ</span></h2>
<div id="breakout-wrap">
<canvas height="360" id="breakout" width="520"></canvas>
<div>ç –å—å‰©ä½™ï¼š<b id="bo-left">0</b>ã€€ç”Ÿå‘½ï¼š<b id="bo-life">2</b></div>
<button class="retry" id="retryBo">é‡è¯•æœ¬å…³</button>
</div>
<p style="opacity:.85">é¼ æ ‡/è§¦æ§ç§»åŠ¨æŒ¡æ¿ï¼›æ¥ä½æ‰è½é“å…·è·å¾—æ•ˆæœ</p>
</div>
<!-- Stage6 è¿·å®«ï¼ˆéšæœºç”Ÿæˆï¼‰ -->
<div class="stage hidden" id="stage6">
<h2>ç¬¬å…­å…³ï¼šè¿·å®«æ¢é™© ğŸŒ€</h2>
<div id="maze-wrap">
<div id="maze-grid"></div>
<div class="dirpad">
<button data-dir="U">â¬†ï¸</button>
<div>
<button data-dir="L">â¬…ï¸</button>
<button data-dir="D">â¬‡ï¸</button>
<button data-dir="R">â¡ï¸</button>
</div>
</div>
<div>é”®ç›˜ WASD/æ–¹å‘é”® æˆ– ç‚¹å‡»æ–¹å‘æŒ‰é’®ç§»åŠ¨ï¼›èµ°åˆ° <b style="color:var(--green)">ç»¿è‰²å‡ºå£</b></div>
</div>
</div>
<!-- Stage7 æƒ…ä¾£ç­”é¢˜ -->
<div class="stage hidden" id="stage7">
<h2>ç¬¬ä¸ƒå…³ï¼šæƒ…ä¾£ç­”é¢˜ ğŸ’‘</h2>
<div id="question" style="margin:12px 0;font-size:1.2em;"></div>
<div id="answers" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;"></div>
<div class="toast" id="toast">ç­”å¯¹å•¦ï¼ğŸ‰</div>
</div>
<!-- Stage8 å½©è›‹ -->
<div class="stage hidden" id="stage8">
<div id="final-msg">ğŸ‰ ç”Ÿæ—¥å¿«ä¹ï¼Œæ²ˆé›¨åªï¼æˆ‘çˆ±ä½  â¤ï¸</div>
<img alt="photo" id="final-photo" src="https://kkkksslls.oss-cn-beijing.aliyuncs.com/syp/20250917-142843.jpg"/>
<p style="opacity:.9">è½»ç‚¹å±å¹•å¯å†æ”¾ä¸€æ³¢çƒŸèŠ±âœ¨</p>
</div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
    /* ========= æ˜Ÿç©ºèƒŒæ™¯ ========= */
    const bg = document.getElementById('bg'), bctx = bg.getContext('2d');
    function fit(){ bg.width = innerWidth; bg.height = innerHeight }
    fit(); addEventListener('resize', fit);
    const stars = Array.from({length:120}).map(()=>({x:Math.random()*bg.width,y:Math.random()*bg.height,r:Math.random()*1.5,vx:(Math.random()-.5)*.05}));
    (function loop(){
      bctx.clearRect(0,0,bg.width,bg.height); bctx.fillStyle='#fff';
      stars.forEach(s=>{
        bctx.globalAlpha=.9; bctx.beginPath(); bctx.arc(s.x,s.y,s.r,0,Math.PI*2); bctx.fill();
        s.y+=.2; s.x+=s.vx; if(s.y>bg.height) s.y=0; if(s.x>bg.width) s.x=0; if(s.x<0) s.x=bg.width;
      });
      requestAnimationFrame(loop);
    })();

    // ç§»åŠ¨ç«¯é¦–æ¬¡äº¤äº’æ’­æ”¾èƒŒæ™¯éŸ³ä¹
    const music = document.getElementById('bg-music');
    addEventListener('touchstart', ()=>{ if(music.paused) music.play().catch(()=>{}); }, {once:true});
    addEventListener('click',      ()=>{ if(music.paused) music.play().catch(()=>{}); }, {once:true});

    /* ========= å·¥å…·ï¼šèˆå°åˆ‡æ¢ ========= */
    function switchStage(from,to){
      document.getElementById('stage'+from).classList.add('hidden');
      document.getElementById('stage'+to).classList.remove('hidden');
    }

    /* ========= Stage1ï¼šæ‰¾çœŸå¿ƒ ========= */
    (function initHearts(){
      const root = document.getElementById('hearts'); const N = 12; const idx = Math.floor(Math.random()*N);
      for(let i=0;i<N;i++){
        const el = document.createElement('div'); el.className='heart'; el.textContent='ğŸ’–';
        el.style.left = (5 + Math.random()*90) + '%'; el.style.top = (10 + Math.random()*70) + '%';
        if(i===idx) el.dataset.c='1'; root.appendChild(el);
        el.addEventListener('click', ()=>{
          if(el.dataset.c){ confetti({particleCount:60,spread:120,origin:{y:.5}}); switchStage(1,2); startCatchGame(); }
          else{ el.style.transform='scale(.2) rotate(18deg)'; el.style.opacity='.25'; setTimeout(()=>el.remove(),600); }
        });
      }
    })();

    /* ========= Stage2ï¼šæ¥ç¤¼ç‰©ï¼ˆå¸¦æ¸…ç†ï¼‰ ========= */
    const sCatch = document.getElementById('s-catch'); const sBomb = document.getElementById('s-bomb');
    const scoreEl = document.getElementById('score'); const timerBar = document.getElementById('timerBar'); const retryCatch = document.getElementById('retryCatch');
    let __catch = {dropId:0,timerId:0,moveMouse:null,moveTouch:null,running:false};
    function startCatchGame(){
      stopCatchGame(); // é˜²å¾¡æ¸…ç†
      __catch.running=true; scoreEl.textContent='0'; timerBar.style.width='100%'; retryCatch.style.display='none';
      const stage2 = document.getElementById('stage2'); Array.from(stage2.querySelectorAll('.gift')).forEach(n=>n.remove());
      const basket = document.getElementById('basket'); let bx = innerWidth/2 - 60; basket.style.left = bx+'px';

      __catch.moveMouse = (e)=>{ bx = Math.min(Math.max(10, e.clientX - 60), innerWidth - 130); basket.style.left = bx+'px'; };
      __catch.moveTouch = (e)=>{ const x = e.touches[0].clientX; bx = Math.min(Math.max(10, x - 60), innerWidth - 130); basket.style.left = bx+'px'; };
      addEventListener('mousemove', __catch.moveMouse);
      addEventListener('touchmove', __catch.moveTouch, {passive:true});

      let caught=0;
      __catch.dropId = setInterval(()=>{
        const gift = document.createElement('div'); const isBomb = Math.random()<.18;
        gift.className='gift'; gift.textContent = isBomb ? 'ğŸ’£' : 'ğŸ';
        gift.style.left = Math.random()*(innerWidth-40) + 'px'; gift.style.top='-40px'; stage2.appendChild(gift);
        const fall = setInterval(()=>{
          gift.style.top = (parseFloat(gift.style.top||'-40') + 6 + Math.random()*2) + 'px';
          const gy=gift.offsetTop, gx=gift.offsetLeft, by=innerHeight-86;
          if(gy>by && gx>bx && gx<bx+120){
            if(isBomb){ caught=Math.max(0,caught-1); sBomb && sBomb.play && sBomb.play().catch(()=>{}); }
            else { caught++; sCatch && sCatch.play && sCatch.play().catch(()=>{}); }
            scoreEl.textContent = String(caught);
            confetti({particleCount: isBomb?14:26, spread:70, origin:{x:(gx/innerWidth), y:0.82}});
            clearInterval(fall); gift.remove();
            if(caught>=10){ stopCatchGame(); switchStage(2,3); startPuzzle(); }
          }
          if(gy>innerHeight+60){ clearInterval(fall); gift.remove(); }
        },30);
      }, 880);

      const startTs = Date.now();
      __catch.timerId = setInterval(()=>{
        const left = Math.max(0, 30000 - (Date.now()-startTs));
        timerBar.style.width = (left/30000*100).toFixed(2) + '%';
        if(left<=0){
          stopCatchGame();
          if(caught>=10){ switchStage(2,3); startPuzzle(); }
          else{ retryCatch.style.display='inline-block'; }
        }
      }, 100);
    }
    function stopCatchGame(){
      if(!__catch.running) return;
      __catch.running=false;
      clearInterval(__catch.dropId); clearInterval(__catch.timerId);
      removeEventListener('mousemove', __catch.moveMouse); removeEventListener('touchmove', __catch.moveTouch);
    }
    retryCatch.onclick = ()=> startCatchGame();

    /* ========= Stage3ï¼šæ‹¼å›¾ ========= */
    const IMG = 'https://kkkksslls.oss-cn-beijing.aliyuncs.com/syp/20250917-143046.jpg';
    const puzzleEl = document.getElementById('puzzle'); const puzzleOk = document.getElementById('puzzleOk');
    let firstPiece=null;
    function startPuzzle(){
      puzzleEl.innerHTML=''; puzzleOk.classList.remove('show'); firstPiece=null;
      const idxs = [...Array(9).keys()].sort(()=>Math.random()-.5);
      for(let pos=0; pos<9; pos++){
        const i = idxs[pos]; const d = document.createElement('div'); d.className='p-piece';
        d.style.backgroundImage=`url('${IMG}')`;
        d.style.backgroundPosition=`-${(i%3)*100}px -${Math.floor(i/3)*100}px`;
        d.dataset.correct=i;
        d.onclick=()=>onPieceClick(d);
        puzzleEl.appendChild(d);
      }
    }
    function onPieceClick(p){
      if(!firstPiece){ firstPiece=p; p.style.outline='3px solid #ffd54f'; return; }
      if(firstPiece===p){ p.style.outline=''; firstPiece=null; return; }
      const a=firstPiece,b=p, ai=a.dataset.correct, bi=b.dataset.correct, ab=a.style.backgroundPosition, bb=b.style.backgroundPosition;
      a.dataset.correct=bi; b.dataset.correct=ai; a.style.backgroundPosition=bb; b.style.backgroundPosition=ab; a.style.outline=''; firstPiece=null; checkPuzzle();
    }
    function checkPuzzle(){
      let ok=true; [...puzzleEl.children].forEach((c,i)=>{ if(Number(c.dataset.correct)!==i) ok=false; });
      if(ok){ puzzleOk.classList.add('show'); confetti({particleCount:140,spread:160,origin:{y:.6}});
        setTimeout(()=>{ switchStage(3,4); startAsteroid(); }, 700);
      }
    }

    /* ========= Stage4ï¼šèº²é¿é™¨çŸ³ ========= */
    const asteroidArea = document.getElementById('asteroid-area'); const ship = document.getElementById('ship');
    const astSec = document.getElementById('ast-sec'); const retryAst = document.getElementById('retryAst');
    let ast = { moveId:0, spawnId:0, timerId:0, keys:{}, running:false, tStart:0 };
    function startAsteroid(){
      stopAsteroid();
      ast.running=true; ast.keys={}; ast.tStart=Date.now(); astSec.textContent='20'; retryAst.style.display='none';
      let pos = { x: asteroidArea.clientWidth/2-16, y: asteroidArea.clientHeight-56 };
      ship.style.left = pos.x+'px'; ship.style.top = pos.y+'px';

      function onKeyDown(e){ ast.keys[e.key]=true; } function onKeyUp(e){ ast.keys[e.key]=false; }
      document.addEventListener('keydown', onKeyDown); document.addEventListener('keyup', onKeyUp);

      function onTouchStart(e){
        const rect=asteroidArea.getBoundingClientRect(), x=e.touches[0].clientX-rect.left;
        pos.x += (x<rect.width/2)? -26 : 26;
      }
      function onTouchMove(e){
        const rect=asteroidArea.getBoundingClientRect(); const t=e.touches[0];
        pos.x = Math.max(0, Math.min(t.clientX-rect.left-16, rect.width-32));
        pos.y = Math.max(0, Math.min(t.clientY-rect.top -16, rect.height-32));
      }
      asteroidArea.addEventListener('touchstart', onTouchStart, {passive:true});
      asteroidArea.addEventListener('touchmove',  onTouchMove,  {passive:true});

      function move(){
        if(!ast.running) return;
        if(ast.keys['ArrowLeft']||ast.keys['a']) pos.x-=6;
        if(ast.keys['ArrowRight']||ast.keys['d']) pos.x+=6;
        if(ast.keys['ArrowUp']||ast.keys['w']) pos.y-=6;
        if(ast.keys['ArrowDown']||ast.keys['s']) pos.y+=6;
        const W=asteroidArea.clientWidth,H=asteroidArea.clientHeight;
        pos.x=Math.max(0,Math.min(pos.x,W-32)); pos.y=Math.max(0,Math.min(pos.y,H-32));
        ship.style.left=pos.x+'px'; ship.style.top=pos.y+'px';
        ast.moveId = requestAnimationFrame(move);
      }
      move();

      function spawn(){
        const a = document.createElement('div'); a.className='asteroid'; a.textContent='ğŸª¨';
        a.style.left=Math.random()*(asteroidArea.clientWidth-30)+'px'; a.style.top='-30px'; asteroidArea.appendChild(a);
        const fall=setInterval(()=>{
          if(!ast.running){ clearInterval(fall); a.remove(); return; }
          a.style.top=(a.offsetTop+5)+'px';
          const ax=a.offsetLeft, ay=a.offsetTop, sx=ship.offsetLeft, sy=ship.offsetTop;
          if(Math.abs(ax-sx)<28 && Math.abs(ay-sy)<28){ clearInterval(fall); failAst(); }
          if(ay>asteroidArea.clientHeight+40){ clearInterval(fall); a.remove(); }
        },30);
      }
      ast.spawnId = setInterval(spawn, 700);

      let left=20; ast.timerId=setInterval(()=>{ left--; astSec.textContent=left; if(left<=0){ successAst(); } },1000);

      function successAst(){ if(!ast.running) return; confetti({particleCount:120,spread:160,origin:{y:.6}}); stopAsteroid(); switchStage(4,5); startBreakout(); }
      function failAst(){ if(!ast.running) return; stopAsteroid(); retryAst.style.display='inline-block'; }
      retryAst.onclick = ()=> startAsteroid();
    }
    function stopAsteroid(){
      if(!ast.running) return; ast.running=false;
      cancelAnimationFrame(ast.moveId); clearInterval(ast.spawnId); clearInterval(ast.timerId);
      document.onkeydown=null; document.onkeyup=null;
      asteroidArea.replaceChildren(ship); // ç§»é™¤æ‰€æœ‰é™¨çŸ³
    }

    /* ========= Stage5ï¼šæ‰“ç –å—ï¼ˆå¸¦é“å…· & æ¸…ç†ï¼‰ ========= */
    const boCanvas = document.getElementById('breakout'), boCtx = boCanvas.getContext('2d');
    const boLeftEl = document.getElementById('bo-left'), boLifeEl = document.getElementById('bo-life'), retryBo = document.getElementById('retryBo');
    let bo = { anim:0, bricks:[], balls:[], paddle:null, lives:2, drops:[], running:false, mouseMove:null, touchMove:null };
    const POWERS = ['Expand','Shrink','Multi','Slow','Fast']; // é“å…·
    function startBreakout(){
      stopBreakout();
      bo.running=true; bo.lives=2; bo.drops=[]; bo.balls=[]; bo.bricks=[];
      const W=boCanvas.width, H=boCanvas.height;
      // ç –å—
      const rows=5, cols=9, pad=8, top=40, left=10, bw=Math.floor((W-left*2-pad*(cols-1))/cols), bh=18;
      for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
        bo.bricks.push({x:left+c*(bw+pad),y:top+r*(bh+pad),w:bw,h:bh,alive:true, power: (Math.random()<0.22? POWERS[Math.floor(Math.random()*POWERS.length)] : null) });
      }
      boLeftEl.textContent = bo.bricks.filter(b=>b.alive).length;
      // æŒ¡æ¿/çƒ
      bo.paddle={x:W/2-45,y:H-26,w:90,h:12,speed:12};
      bo.balls.push({x:W/2,y:H/2,r:7,dx:3.2*(Math.random()>.5?1:-1),dy:-3.2,speedMul:1});

      // æ§åˆ¶
      bo.mouseMove = (e)=>{ const rect=boCanvas.getBoundingClientRect(); const x=e.clientX-rect.left;
        bo.paddle.x=Math.max(0,Math.min(x - bo.paddle.w/2, W-bo.paddle.w)); };
      bo.touchMove = (e)=>{ const rect=boCanvas.getBoundingClientRect(); const x=e.touches[0].clientX-rect.left;
        bo.paddle.x=Math.max(0,Math.min(x - bo.paddle.w/2, W-bo.paddle.w)); };
      boCanvas.addEventListener('mousemove', bo.mouseMove);
      boCanvas.addEventListener('touchmove', bo.touchMove, {passive:true});

      function step(){
        if(!bo.running) return;
        // çƒè¿åŠ¨
        for(const b of bo.balls){
          b.x+=b.dx*b.speedMul; b.y+=b.dy*b.speedMul;
          if(b.x<b.r){ b.x=b.r; b.dx=-b.dx; } if(b.x>W-b.r){ b.x=W-b.r; b.dx=-b.dx; }
          if(b.y<b.r){ b.y=b.r; b.dy=-b.dy; }
          // åº•éƒ¨ï¼šæ¼çƒ
          if(b.y>H-b.r){
            bo.lives--; boLifeEl.textContent=Math.max(0,bo.lives);
            if(bo.lives<0){ failBo(); return; }
            // é‡ç½®åˆ°ä¸­å¿ƒ
            b.x=W/2; b.y=H/2; b.dx=3.2*(Math.random()>.5?1:-1); b.dy=-3.2; b.speedMul=1;
          }
          // æŒ¡æ¿
          const p=bo.paddle; if(b.y+b.r>=p.y && b.y-b.r<=p.y+p.h && b.x>=p.x && b.x<=p.x+p.w){
            b.dy=-Math.abs(b.dy);
            const hit=(b.x-(p.x+p.w/2))/(p.w/2); b.dx=Math.max(-5,Math.min(5,b.dx+hit*1.5));
          }
          // ç –å—
          for(const br of bo.bricks){
            if(!br.alive) continue;
            if(b.x>br.x && b.x<br.x+br.w && b.y-b.r<br.y+br.h && b.y+b.r>br.y){
              br.alive=false; b.dy=-b.dy; boLeftEl.textContent=bo.bricks.filter(x=>x.alive).length;
              if(br.power){ // æ‰è½é“å…·
                bo.drops.push({x:br.x+br.w/2,y:br.y,w:16,h:16,type:br.power,vy:2});
              }
            }
          }
        }
        // æ‰è½é“å…·
        for(const d of bo.drops){
          d.y+=d.vy;
          // æ¥åˆ°
          const p=bo.paddle;
          if(d.y+d.h>=p.y && d.x>=p.x && d.x<=p.x+p.w){
            applyPower(d.type);
            d.done=true;
          }
          if(d.y>H+20) d.done=true;
        }
        bo.drops = bo.drops.filter(d=>!d.done);

        // ç»˜åˆ¶
        boCtx.clearRect(0,0,W,H);
        // ç –
        boCtx.fillStyle='#ff80ab';
        bo.bricks.forEach(br=>{ if(br.alive){ boCtx.fillRect(br.x,br.y,br.w,br.h); if(br.power){ boCtx.fillStyle='rgba(255,255,255,.18)'; boCtx.fillRect(br.x,br.y,br.w,br.h); boCtx.fillStyle='#ff80ab'; } }});
        // æŒ¡æ¿
        boCtx.fillStyle='#ffd54f'; boCtx.fillRect(bo.paddle.x,bo.paddle.y,bo.paddle.w,bo.paddle.h);
        // çƒ
        boCtx.fillStyle='#fff'; bo.balls.forEach(b=>{ boCtx.beginPath(); boCtx.arc(b.x,b.y,b.r,0,Math.PI*2); boCtx.fill(); });
        // é“å…·
        boCtx.font='12px system-ui'; boCtx.textAlign='center'; boCtx.textBaseline='middle';
        bo.drops.forEach(d=>{ boCtx.fillStyle='#fff'; boCtx.beginPath(); boCtx.arc(d.x,d.y,10,0,Math.PI*2); boCtx.fill();
          boCtx.fillStyle='#000'; boCtx.fillText(iconOf(d.type), d.x, d.y+0.5); });

        // èƒœåˆ©
        if(bo.bricks.every(b=>!b.alive)){ successBo(); return; }

        bo.anim = requestAnimationFrame(step);
      }
      boLifeEl.textContent=bo.lives; bo.anim=requestAnimationFrame(step);

      function iconOf(t){ return ({Expand:'E',Shrink:'S',Multi:'M',Slow:'âª',Fast:'â©'})[t]||'?'; }
      function applyPower(t){
        const p=bo.paddle;
        if(t==='Expand') p.w=Math.min(p.w+30, 140);
        if(t==='Shrink') p.w=Math.max(p.w-25, 60);
        if(t==='Multi'){ // å¤åˆ¶ä¸¤é¢—çƒ
          const add=[]; bo.balls.forEach(b=>{ add.push({x:b.x,y:b.y,r:b.r,dx:-b.dx,dy:b.dy,speedMul:b.speedMul}); });
          bo.balls.push(...add);
        }
        if(t==='Slow')  bo.balls.forEach(b=> b.speedMul=Math.max(0.7, b.speedMul-0.2));
        if(t==='Fast')  bo.balls.forEach(b=> b.speedMul=Math.min(1.7, b.speedMul+0.25));
      }
      function successBo(){ if(!bo.running) return; confetti({particleCount:160,spread:200,origin:{y:.6}}); stopBreakout(); switchStage(5,6); startMaze(); }
      function failBo(){ if(!bo.running) return; stopBreakout(); retryBo.style.display='inline-block'; }
      retryBo.onclick = ()=> startBreakout();
    }
    function stopBreakout(){
      if(!bo.running) return; bo.running=false;
      cancelAnimationFrame(bo.anim); boCtx.clearRect(0,0,boCanvas.width,boCanvas.height);
      boCanvas.removeEventListener('mousemove', bo.mouseMove); boCanvas.removeEventListener('touchmove', bo.touchMove);
    }

    /* ========= Stage6ï¼šéšæœºè¿·å®« ========= */
    const mazeGrid = document.getElementById('maze-grid');
    const dirButtons = document.querySelectorAll('.dirpad button');
    let mz = {N:0, grid:[], px:1, py:1, ex:0, ey:0, keyHandler:null};
    function startMaze(sizeOdd){
      stopMaze();
      const N = sizeOdd || [11,13,15][Math.floor(Math.random()*3)]; // å¥‡æ•°å¤§å°
      mz.N=N; mazeGrid.style.gridTemplateColumns=`repeat(${N},26px)`; mazeGrid.style.gridTemplateRows=`repeat(${N},26px)`;
      // åˆå§‹åŒ–ï¼šå…¨å¢™
      const G = Array.from({length:N}, ()=>Array.from({length:N},()=>0)); // 0å¢™,1è·¯
      // æŒ–è¿·å®«ï¼ˆé€’å½’å›æº¯ï¼‰
      function carve(x,y){
        G[y][x]=1;
        const dirs=[[2,0],[0,2],[-2,0],[0,-2]].sort(()=>Math.random()-.5);
        for(const [dx,dy] of dirs){
          const nx=x+dx, ny=y+dy;
          if(nx>0 && nx<N-1 && ny>0 && ny<N-1 && G[ny][nx]===0){
            G[y+dy/2][x+dx/2]=1; carve(nx,ny);
          }
        }
      }
      carve(1,1);
      // èµ·ç‚¹(1,1) ç»ˆç‚¹è®¾åœ¨æœ€è¿œè§’è½ä¹‹ä¸€
      mz.px=1; mz.py=1;
      const exits=[[N-2,N-2],[1,N-2],[N-2,1]];
      [mz.ex,mz.ey] = exits[Math.floor(Math.random()*exits.length)];

      // æ¸²æŸ“
      mazeGrid.innerHTML='';
      for(let y=0;y<N;y++){
        for(let x=0;x<N;x++){
          const d=document.createElement('div'); d.className='cell';
          if(G[y][x]===0) d.classList.add('wall');
          if(x===mz.px && y===mz.py){ d.classList.add('player'); }
          if(x===mz.ex && y===mz.ey){ d.classList.add('exit'); }
          d.dataset.x=x; d.dataset.y=y; mazeGrid.appendChild(d);
        }
      }
      mz.grid=G;
      function draw(){
        [...mazeGrid.children].forEach(c=>c.classList.remove('player'));
        mazeGrid.children[mz.py*N+mz.px].classList.add('player');
      }
      function move(dx,dy){
        const nx=mz.px+dx, ny=mz.py+dy;
        if(nx>=0 && nx<N && ny>=0 && ny<N && G[ny][nx]===1){
          mz.px=nx; mz.py=ny; draw();
          if(nx===mz.ex && ny===mz.ey){
            confetti({particleCount:160,spread:200,origin:{y:.6}});
            stopMaze(); switchStage(6,7); loadQuestion();
          }
        }
      }
      // é”®ç›˜
      mz.keyHandler=(e)=>{
        const k=e.key.toLowerCase();
        if(k==='arrowup'||k==='w') move(0,-1);
        if(k==='arrowdown'||k==='s') move(0,1);
        if(k==='arrowleft'||k==='a') move(-1,0);
        if(k==='arrowright'||k==='d') move(1,0);
      };
      addEventListener('keydown', mz.keyHandler);
      // è§¦æ§
      dirButtons.forEach(b=> b.onclick=()=>{ const m=b.dataset.dir; if(m==='U')move(0,-1); if(m==='D')move(0,1); if(m==='L')move(-1,0); if(m==='R')move(1,0); });
    }
    function stopMaze(){ if(mz.keyHandler){ removeEventListener('keydown', mz.keyHandler); mz.keyHandler=null; } }

    /* ========= Stage7ï¼šæƒ…ä¾£ç­”é¢˜ ========= */
    const Qs = [
      {q:"æˆ‘ä»¬ç¬¬ä¸€æ¬¡è§é¢æ˜¯ï¼Ÿ", a:["å›¾ä¹¦é¦†","æ“åœº","å…¬å¸"], correct:2},
      {q:"æˆ‘æœ€å–œæ¬¢çš„æ°´æœæ˜¯ï¼Ÿ", a:["è‰è“","è¥¿ç“œ","èŠ’æœ"], correct:1},
      {q:"æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç‰µæ‰‹æ˜¯åœ¨ï¼Ÿ", a:["ç”µå½±é™¢","å…¬äº¤è½¦","ç”µæ¢¯"], correct:2}
    ];
    const qsEl=document.getElementById('question'), ansEl=document.getElementById('answers'), toast=document.getElementById('toast');
    let qi=0;
    function loadQuestion(){
      const q=Qs[qi]; qsEl.textContent=q.q; ansEl.innerHTML='';
      q.a.forEach((t,i)=>{ const b=document.createElement('button'); b.textContent=t; b.onclick=()=>checkAnswer(i); ansEl.appendChild(b); });
    }
    function checkAnswer(i){
      const q=Qs[qi];
      if(i===q.correct){
        confetti({particleCount:120,spread:180,origin:{y:.6}});
        toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 800);
        if(qi<Qs.length-1){ qi++; setTimeout(loadQuestion, 350); }
        else{ switchStage(7,8); finale(); }
      }else{ alert('ç­”é”™å•¦ï¼Œå†æƒ³æƒ³ï½'); }
    }

    /* ========= Stage8ï¼šå½©è›‹ ========= */
    function finale(){
      let id=setInterval(()=>{ confetti({particleCount:200,spread:260,origin:{y:.6}}); }, 900);
      document.getElementById('stage8').addEventListener('click', ()=>{ confetti({particleCount:240,spread:280}); });
      // å¦‚éœ€åˆ‡éŸ³ä¹ï¼šå–æ¶ˆæ³¨é‡Š
      // const bg=document.getElementById('bg-music'); bg.src='love.mp3'; bg.play().catch(()=>{});
      setTimeout(()=>clearInterval(id), 12000);
    }

    /* ========= å¯åŠ¨é¡ºåºæç¤º =========
      1 -> 2(startCatchGame) -> 3(startPuzzle) -> 4(startAsteroid) -> 5(startBreakout)
      -> 6(startMaze) -> 7(loadQuestion) -> 8(finale)
    ================================== */
  </script>
<script>
const music = document.getElementById("bg-music");
music.oncanplaythrough = () => console.log("âœ… éŸ³ä¹åŠ è½½æˆåŠŸï¼Œå¯ä»¥æ’­æ”¾");
music.onerror = () => console.log("âŒ éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥è·¯å¾„æˆ–æ–‡ä»¶å");

function unlockAudio() {
  music.muted = false;
  music.play().then(()=>{
    console.log("ğŸµ éŸ³ä¹å¼€å§‹æ’­æ”¾");
  }).catch(err=>{
    console.log("âš ï¸ æ’­æ”¾å¤±è´¥:", err);
  });
  document.removeEventListener("click", unlockAudio);
  document.removeEventListener("touchstart", unlockAudio);
}
document.addEventListener("click", unlockAudio);
document.addEventListener("touchstart", unlockAudio);
</script></body>
</html>
